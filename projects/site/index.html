
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.8">
    
    
      
        <title>Elastic ML Whitelist Guide</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#elastic-ml-whitelist-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Elastic ML Whitelist Guide" class="md-header__button md-logo" aria-label="Elastic ML Whitelist Guide" data-md-component="logo">
      
  <img src="images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Elastic ML Whitelist Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Elastic ML Whitelist Guide" class="md-nav__button md-logo" aria-label="Elastic ML Whitelist Guide" data-md-component="logo">
      
  <img src="images/logo.png" alt="logo">

    </a>
    Elastic ML Whitelist Guide
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        Home
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#steps" class="md-nav__link">
    Steps
  </a>
  
    <nav class="md-nav" aria-label="Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-train-the-model-locally" class="md-nav__link">
    1. Train the Model Locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-import-the-model-into-elasticsearch" class="md-nav__link">
    2. Import the Model into Elasticsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-create-an-elasticsearch-ingest-pipeline-with-the-inference-processor" class="md-nav__link">
    3. Create an Elasticsearch Ingest Pipeline with the Inference Processor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-create-a-new-pipeline-to-route-whitelisted-alerts-to-a-new-index" class="md-nav__link">
    4. Create a New Pipeline to Route Whitelisted Alerts to a New Index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-configure-filebeat-or-logstash-to-use-the-new-pipeline" class="md-nav__link">
    5. Configure Filebeat or Logstash to Use the New Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#steps" class="md-nav__link">
    Steps
  </a>
  
    <nav class="md-nav" aria-label="Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-train-the-model-locally" class="md-nav__link">
    1. Train the Model Locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-import-the-model-into-elasticsearch" class="md-nav__link">
    2. Import the Model into Elasticsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-create-an-elasticsearch-ingest-pipeline-with-the-inference-processor" class="md-nav__link">
    3. Create an Elasticsearch Ingest Pipeline with the Inference Processor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-create-a-new-pipeline-to-route-whitelisted-alerts-to-a-new-index" class="md-nav__link">
    4. Create a New Pipeline to Route Whitelisted Alerts to a New Index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-configure-filebeat-or-logstash-to-use-the-new-pipeline" class="md-nav__link">
    5. Configure Filebeat or Logstash to Use the New Pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="elastic-ml-whitelist-guide">Elastic ML Whitelist Guide</h1>
<p>Welcome to the Elastic ML Whitelist Guide! This guide will walk you through creating and using a trained machine learning model to predict whether alerts in Elastic should be whitelisted or not.</p>
<p><img alt="Machine Learning" src="images/Elastic%20Rule%20Exception%20Machine%20Learning%20Model%20Workflow%20%283%29.png" /></p>
<h2 id="steps">Steps</h2>
<h3 id="1-train-the-model-locally">1. Train the Model Locally</h3>
<p>Train a machine learning model using historical Elastic data. Preprocess data as needed before training the model. Save the trained model to a file (e.g., using <code>pickle</code>).</p>
<h3 id="2-import-the-model-into-elasticsearch">2. Import the Model into Elasticsearch</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">eland</span> <span class="k">as</span> <span class="nn">ed</span>
<span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="n">es_client</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">(</span><span class="s2">&quot;http://localhost:9200&quot;</span><span class="p">)</span> 
</code></pre></div>
<p>Replace 'path/to/trained_model.pkl' with the path to saved model file</p>
<div class="highlight"><pre><span></span><code>with open(&quot;path/to/trained_model.pkl&quot;, &quot;rb&quot;) as model_file:
    model = pickle.load(model_file)

model_id = &quot;imported-model-id&quot;
ed.ml.import_model(es_client, model, model_id)
</code></pre></div>
<h3 id="3-create-an-elasticsearch-ingest-pipeline-with-the-inference-processor">3. Create an Elasticsearch Ingest Pipeline with the Inference Processor</h3>
<div class="highlight"><pre><span></span><code>pipeline_id = &quot;whitelist-prediction-pipeline&quot;

pipeline_body = {
    &quot;description&quot;: &quot;Pipeline to predict if an alert should be whitelisted&quot;,
    &quot;processors&quot;: [ 
        {
            &quot;inference&quot;: {
                &quot;model_id&quot;: model_id,
                &quot;inference_config&quot;: {&quot;classification&quot;: {}},
                &quot;field_map&quot;: {}, # Dependant Variables
                &quot;target_field&quot;: &quot;whitelist_prediction&quot;, #Independant Variable
            }
        }
    ],
}

es_client.ingest.put_pipeline(id=pipeline_id, body=pipeline_body)
</code></pre></div>
<h3 id="4-create-a-new-pipeline-to-route-whitelisted-alerts-to-a-new-index">4. Create a New Pipeline to Route Whitelisted Alerts to a New Index</h3>
<div class="highlight"><pre><span></span><code>whitelisted_alerts_index = &quot;whitelisted-alerts&quot;
new_pipeline_id = &quot;route-to-whitelisted-index&quot;

new_pipeline_body = {
    &quot;description&quot;: &quot;Pipeline to route whitelisted alerts to a new index&quot;,
    &quot;processors&quot;: [
        {
            &quot;conditional&quot;: {
                &quot;if&quot;: &quot;ctx.whitelist_prediction.class_name == &#39;1&#39;&quot;,
                &quot;processors&quot;: [
                    {
                        &quot;index&quot;: {
                            &quot;index&quot;: whitelisted_alerts_index,
                        }
                    }
                ],
            }
        },
    ],
}

es_client.ingest.put_pipeline(id=new_pipeline_id, body=new_pipeline_body)
</code></pre></div>
<h3 id="5-configure-filebeat-or-logstash-to-use-the-new-pipeline">5. Configure Filebeat or Logstash to Use the New Pipeline</h3>
<h1 id="filebeatyml">filebeat.yml</h1>
<div class="highlight"><pre><span></span><code>filebeat.inputs:
- type: log
  paths:
    - /path/to/alert/logs/*.log
  fields:
    pipeline: &quot;route-to-whitelisted-index&quot;

output.elasticsearch:
  hosts: [&quot;http://localhost:9200&quot;]
  pipeline: &quot;%{[fields.pipeline]}&quot;
</code></pre></div>
<h1 id="logstashconf">logstash.conf</h1>
<div class="highlight"><pre><span></span><code>output {
  elasticsearch {
    hosts =&gt; [&quot;http://localhost:9200&quot;]
    index =&gt; &quot;siem-index&quot;
    pipeline =&gt; &quot;route-to-whitelisted-index&quot;
  }
}
</code></pre></div>
<h3 id="reference-links">Reference Links</h3>
<p>https://eland.readthedocs.io/en/v8.3.0/reference/api/eland.ml.MLModel.import_model.html</p>
<p>https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html</p>
<p>https://www.elastic.co/guide/en/elasticsearch/client/eland/current/overview.html</p>
<h3 id="index">Index</h3>
<p>An Inference Processor is part of the Elasticsearch ingest pipeline that allows you to use pre-trained Ml Models to enrich data during indexing. So it'll apply the ML Model to incoming documents and add the model's prediction results as new fields in the documents before they are stored in an Elastic index.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>