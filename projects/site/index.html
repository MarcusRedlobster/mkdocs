
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.8">
    
    
      
        <title>Projects</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#elastic-machine-learning-whitelist-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Projects" class="md-header__button md-logo" aria-label="Projects" data-md-component="logo">
      
  <img src="images/redlobster.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Projects
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Elastic ML Whitelist Project
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Projects" class="md-nav__button md-logo" aria-label="Projects" data-md-component="logo">
      
  <img src="images/redlobster.png" alt="logo">

    </a>
    Projects
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Elastic ML Whitelist Project
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        Elastic ML Whitelist Project
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#steps" class="md-nav__link">
    Steps
  </a>
  
    <nav class="md-nav" aria-label="Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-the-data" class="md-nav__link">
    Get the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-data-ready-transform-clean" class="md-nav__link">
    Getting the data ready: Transform &amp; Clean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-model-trainng" class="md-nav__link">
    Elastic Model Trainng
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-pipeline" class="md-nav__link">
    Elastic Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-azure-function" class="md-nav__link">
    Creating Azure Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#steps" class="md-nav__link">
    Steps
  </a>
  
    <nav class="md-nav" aria-label="Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-the-data" class="md-nav__link">
    Get the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-data-ready-transform-clean" class="md-nav__link">
    Getting the data ready: Transform &amp; Clean
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-model-trainng" class="md-nav__link">
    Elastic Model Trainng
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-pipeline" class="md-nav__link">
    Elastic Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-azure-function" class="md-nav__link">
    Creating Azure Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="elastic-machine-learning-whitelist-guide">Elastic Machine Learning Whitelist Guide</h1>
<p>Welcome to the Elastic Machine Learning Whitelist Guide! This guide will walk you through creating and using a trained machine learning model to predict whether alerts in Elastic should be whitelisted or not.</p>
<p><img alt="Machine Learning" src="images/Elastic%20Rule%20Exception%20Machine%20Learning%20Model%20Workflow%20%283%29.png" /></p>
<h2 id="steps">Steps</h2>
<h3 id="get-the-data">Get the data</h3>
<p>The first step to training a machine learning model is to get the data that you need, for this specific project we will download the data that we need from Elastic. We can do that by going to <strong>Elastic&gt; Click on the hamburger icon at the top left of the screen&gt; Under the Analytics section click on Discover.</strong></p>
<p>Now that we are on the Discover page we need to switch our index to our siem index after this, we can then begin to download the necessary data, first lets select a date by clicking on the time picker then, we can click on <strong>Share</strong> at the top right of the screen, and click <strong>CSV Reports&gt; Generate CSV</strong>. We want to download as much data as we need and we can do so by repeating the steps above as there is a limit on how much data you can download at once.</p>
<h3 id="getting-the-data-ready-transform-clean">Getting the data ready: Transform &amp; Clean</h3>
<p>Now that we have our data we want to get our data ready for training, we are going to need to concatenate all those csv files that we previously downloaded and then we want to clean up the data a bit, here is how we do that.</p>
<p>This code will request the list of features you would like your model to have and, put those features in parenthesis and add a comma at the end of each feature so that you can easily copy and paste the text into the code below.
<div class="highlight"><pre><span></span><code><span class="n">words_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please paste the list of words: &quot;</span><span class="p">)</span>

<span class="n">words</span> <span class="o">=</span> <span class="n">words_input</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">processed_words</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">&#39;,&quot;</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">processed_words</span><span class="p">)</span>
</code></pre></div>
Now that we have the features we want our model to be trained with lets concatenate those csv files we previously downloaded (make sure to rename these files accordingly e.g. file1.csv, file2.csv, file3.csv) and then remove every column that is not in our feature list.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;file1.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;file3.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;file4.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;file5.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;file6.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;file7.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;file8.csv&#39;</span><span class="p">]</span>

<span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">on_bad_lines</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">, Columns: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;kibana.alert.rule.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;user.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;user.domain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;host.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;event.category&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source.ip&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source.port&#39;</span><span class="p">,</span>
    <span class="s1">&#39;destination.port&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dns.question.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dns.question.type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file.path&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dll.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dll.path&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process.parent.name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process.executable&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process.working_directory&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process.args&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process.hash.sha256&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dll.hash.sha256&#39;</span><span class="p">,</span>
    <span class="s1">&#39;signal.reason&#39;</span>
<span class="p">]</span>

<span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_keep</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">cols_to_keep</span><span class="p">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="n">result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;siem.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="elastic-model-trainng">Elastic Model Trainng</h3>
<p>To import our data into elastic <strong>Click on the hamburger icon at the top left of the screen&gt; Then on Machine Learning&gt; and then on File&gt; Import the appropriate csv file that was concatenated and cleaned.</strong> Now that we have our data ready to go, lets train our model. <strong>Click on the hamburger icon at the top left of the screen&gt; Under Analytics click on Machine Learning&gt; Under Data Frame Analytics click on Jobs&gt; Then click Create job</strong> As we create our ML mode make sure to set "Feature Importance Values to the amount of features we have.</p>
<h3 id="elastic-pipeline">Elastic Pipeline</h3>
<p>Now that we have our model created we can now create the pipeline that will run our model againts our elastic siem logs. See code below, you can copy and paste the code in the Elastic Dev Console (Make sure to configure Pipeline Name, Description, Mode ID, and Field Map)</p>
<div class="highlight"><pre><span></span><code>PUT _ingest/pipeline/ml-mitre-ta0002-execution-pipeline 

{ 

  &quot;description&quot;: &quot;Inference pipeline for ml-mitre-ta0002-execution model&quot;, 

  &quot;processors&quot;: [ 

    { 

      &quot;inference&quot;: { 

        &quot;model_id&quot;: &quot;ml-mitre-ta0002-execution-model-1686766767712&quot;, 

        &quot;inference_config&quot;: { 

          &quot;classification&quot;: {} 

        }, 

        &quot;field_map&quot;: { 

          &quot;user.name&quot;: &quot;user_name&quot;, 

          &quot;host.name&quot;: &quot;host_name&quot;, 

          &quot;process.name&quot;: &quot;process_name&quot;, 

          &quot;process.parent.name&quot;: &quot;process_parent_name&quot;, 

          &quot;process.executable&quot;: &quot;process_executable&quot;, 

          &quot;process.parent.executable&quot;: &quot;process_parent_executable&quot;, 

          &quot;process.working_directory&quot;: &quot;process_working_directory&quot;, 

          &quot;process.parent.working_directory&quot;: &quot;process_parent_working_directory&quot;, 

          &quot;process.args&quot;: &quot;process_args&quot;, 

          &quot;process.parent.args&quot;: &quot;process_parent_args&quot;, 

          &quot;process.entity_id&quot;: &quot;process_entity_id&quot;, 

          &quot;process.parent.entity_id&quot;: &quot;process_parent_entity_id&quot;, 

          &quot;host.os.type&quot;: &quot;host_os_type&quot; 

        } 

      } 

    }, 

    { 

      &quot;script&quot;: { 

        &quot;source&quot;: &quot;&quot;&quot; 

          if (ctx.containsKey(&#39;user&#39;) &amp;&amp; ctx.user.containsKey(&#39;id&#39;) &amp;&amp; ctx.user.id instanceof String) { 

            try { 

              ctx.user.id = Long.parseLong(ctx.user.id); 

            } catch (NumberFormatException e) { 

              ctx.user.id = null; 

            } 

          } 

        &quot;&quot;&quot; 

      } 

    }, 

    { 

      &quot;set&quot;: { 

        &quot;field&quot;: &quot;whitelist&quot;, 

        &quot;value&quot;: &quot;{{ml.inference.whitelist}}&quot; 

      } 

    }, 

    { 

      &quot;script&quot;: { 

        &quot;source&quot;: &quot;&quot;&quot; 

          if (ctx.whitelist.equals(&quot;1&quot;)) { 

            ctx.whitelist = true; 

          } else if (ctx.whitelist.equals(&quot;0&quot;)) { 

            ctx.whitelist = false; 

          } 

        &quot;&quot;&quot; 

      } 

    } 

  ] 

} 
</code></pre></div>
<h3 id="creating-azure-function">Creating Azure Function</h3>
<p>Now that we have the pipeline and the model all done, next we need to set up an Azure Function so that we can automate the process of running our models againts our siem logs. Here is how we do that...</p>
<ol>
<li>Activate your role in azure</li>
<li>Download the <strong>"Azure Account", "Azure Functions", and "Azure Resources"</strong> extensions in VSCode.</li>
<li>Click on the <strong>Azure Icon</strong> on the left side bar in VSCode.</li>
<li>Sign into your <strong>Azure account</strong>.</li>
<li>Create an Azure Function by clicking on the <strong>Subscription</strong> of your choice, then right click on <strong>Function App</strong>, then click <strong>Create Function App in Azure</strong></li>
<li>Enter a <strong>Globally Unique</strong> name for you Azure Function.</li>
<li>Select the appropriate <strong>Coding Language</strong></li>
<li>Select a <strong>Location</strong></li>
<li>Select a <strong>Resource Group</strong></li>
<li>Now you can insert your code into the .py file called <strong><strong>init</strong>.py</strong></li>
</ol>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>